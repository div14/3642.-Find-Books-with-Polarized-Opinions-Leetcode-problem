# Write your MySQL query statement below
with new as (select b.book_id, 
       b.title, 
       b.author, 
       b.genre, 
       b.pages, 
       count(rs.session_id) as count_reading_session,
       sum(case when rs.session_rating<=2 then 1 else 0 end) as has_rating_atleast_2,
       sum(case when rs.session_rating>=4 then 1 else 0 end) as has_rating_atleast_4,
       max(rs.session_rating)-min(rs.session_rating) as rating_spread,

       round((sum(case when rs.session_rating<=2 then 1 else 0 end)+ 
       sum(case when rs.session_rating>=4 then 1 else 0 end)) * 1.0 / count(rs.session_id),2) as polarization_score

from books b
join reading_sessions rs on b.book_id=rs.book_id
group by b.book_id)

select book_id, 
       title, 
       author, 
       genre, 
       pages, 
       rating_spread, 
       polarization_score
from new
where count_reading_session>=5 and
      polarization_score>=0.6 and
      has_rating_atleast_2>0 and has_rating_atleast_4>0
order by polarization_score DESC, title DESC;
